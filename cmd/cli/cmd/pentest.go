package cmd

import (
	"os"

	"github.com/nullify-platform/cli/internal/pentest"
	"github.com/nullify-platform/logger/pkg/logger"
	"github.com/spf13/cobra"
)

var pentestCmd = &cobra.Command{
	Use:   "pentest",
	Short: "Run a pentest scan against your API endpoints",
	Long:  "Run pentest scans against your API endpoints. Supports local Docker-based scanning and cloud-based scanning.",
	Run: func(cmd *cobra.Command, args []string) {
		ctx := setupLogger()
		defer logger.L(ctx).Sync()

		pentestArgs := getPentestArgs(cmd)
		nullifyClient := getNullifyClient(ctx)

		err := pentest.RunPentestScan(ctx, pentestArgs, nullifyClient, getLogLevel())
		if err != nil {
			logger.L(ctx).Error(
				"failed to run pentest scan",
				logger.Err(err),
			)
			os.Exit(1)
		}
	},
}

func init() {
	rootCmd.AddCommand(pentestCmd)

	pentestCmd.Flags().String("app-name", "", "The unique name of the app to be scanned")
	pentestCmd.Flags().String("spec-path", "", "The file path to the OpenAPI file (yaml or json)")
	_ = pentestCmd.MarkFlagRequired("spec-path")
	pentestCmd.Flags().String("target-host", "", "The base URL of the API to be scanned")
	pentestCmd.Flags().StringSlice("header", nil, "Headers for the pentest agent to authenticate with your API")

	pentestCmd.Flags().String("github-owner", "", "The GitHub username or organisation")
	pentestCmd.Flags().String("github-repo", "", "The repository name for the Nullify issue dashboard")

	pentestCmd.Flags().Bool("local", false, "Run the pentest locally using Docker for scanning private networks")
	pentestCmd.Flags().String("image-label", "latest", "Version of the pentest local image used for scanning")
	pentestCmd.Flags().Bool("force-pull", false, "Force a docker pull of the latest pentest local image")
	pentestCmd.Flags().Bool("use-host-network", false, "Use the host network for the local pentest scan")

	pentestCmd.Flags().String("auth-config", "", "The path to the pentest auth config file")
}

func getPentestArgs(cmd *cobra.Command) *pentest.PentestScan {
	appName, _ := cmd.Flags().GetString("app-name")
	specPath, _ := cmd.Flags().GetString("spec-path")
	targetHost, _ := cmd.Flags().GetString("target-host")
	headers, _ := cmd.Flags().GetStringSlice("header")
	githubOwner, _ := cmd.Flags().GetString("github-owner")
	githubRepo, _ := cmd.Flags().GetString("github-repo")
	local, _ := cmd.Flags().GetBool("local")
	imageLabel, _ := cmd.Flags().GetString("image-label")
	forcePull, _ := cmd.Flags().GetBool("force-pull")
	useHostNetwork, _ := cmd.Flags().GetBool("use-host-network")
	pentestAuthConfig, _ := cmd.Flags().GetString("auth-config")

	return &pentest.PentestScan{
		AppName:          appName,
		Path:             specPath,
		TargetHost:       targetHost,
		AuthHeaders:      headers,
		GitHubOwner:      githubOwner,
		GitHubRepository: githubRepo,
		Local:            local,
		ImageLabel:       imageLabel,
		ForcePullImage:   forcePull,
		UseHostNetwork:   useHostNetwork,
		AuthConfig:       pentestAuthConfig,
	}
}
