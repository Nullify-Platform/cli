package pentest

import (
	"context"

	"github.com/nullify-platform/cli/internal/client"
	"github.com/nullify-platform/cli/internal/lib"
	"github.com/nullify-platform/cli/internal/models"
	"github.com/nullify-platform/logger/pkg/logger"
)

type PentestScan struct {
	AppName     string
	Path        string
	TargetHost  string
	AuthHeaders []string

	GitHubOwner      string
	GitHubRepository string

	// local scan settings
	Local          bool
	ImageLabel     string
	ForcePullImage bool
	UseHostNetwork bool

	AuthConfig string
}

func RunPentestScan(ctx context.Context, scan *PentestScan, nullifyClient *client.NullifyClient, logLevel string) error {
	spec, err := lib.CreateOpenAPIFile(ctx, scan.Path)
	if err != nil {
		logger.L(ctx).Error("failed to create openapi file", logger.Err(err))
		return err
	}

	authHeaders, err := lib.ParseAuthHeaders(ctx, scan.AuthHeaders)
	if err != nil {
		logger.L(ctx).Error("failed to parse auth headers", logger.Err(err))
		return err
	}

	// Create auth config
	authConfig := models.AuthConfig{
		Headers: authHeaders,
	}

	// Read auth config file
	if scan.AuthConfig != "" {
		fileAuthConfig, err := lib.ParseAuthConfig(ctx, scan.AuthConfig)
		if err != nil {
			logger.L(ctx).Error("failed to parse auth config", logger.Err(err))
			return err
		}
		authConfig = *fileAuthConfig
	}

	if scan.Local {
		logger.L(ctx).Info("starting local scan")
		err = RunLocalScan(
			ctx,
			nullifyClient,
			scan.GitHubOwner,
			scan.GitHubRepository,
			&PentestExternalScanInput{
				AppName:     scan.AppName,
				TargetHost:  scan.TargetHost,
				OpenAPISpec: spec,
				AuthConfig:  authConfig,
			},
			scan.ImageLabel,
			scan.ForcePullImage,
			scan.UseHostNetwork,
			logLevel,
		)
		if err != nil {
			logger.L(ctx).Error("failed to send request", logger.Err(err))
			return err
		}
	} else {
		logger.L(ctx).Info("starting server side scan")
		out, err := nullifyClient.DASTStartCloudScan(ctx, scan.GitHubOwner, &client.DASTStartCloudScanInput{
			AppName:     scan.AppName,
			TargetHost:  scan.TargetHost,
			OpenAPISpec: spec,
			AuthConfig:  authConfig,
			RequestProvider: models.RequestProvider{
				GitHubOwner: scan.GitHubOwner,
			},
			RequestDashboardTarget: models.RequestDashboardTarget{
				GitHubRepository: scan.GitHubRepository,
			},
		})
		if err != nil {
			logger.L(ctx).Error("failed to send request", logger.Err(err))
			return err
		}

		logger.L(ctx).Info("request sent successfully", logger.String("scanId", out.ScanID))
	}

	return nil
}
